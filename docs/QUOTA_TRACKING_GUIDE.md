# Quota Tracking Guide for ElfAutomations

## Overview

The quota tracking system helps teams manage their API costs by:
- Tracking usage per team in real-time
- Enforcing daily budgets
- Automatically falling back to cheaper models
- Providing detailed usage reports
- Preventing unexpected overage charges

## Quick Start

### 1. Creating Quota-Tracked Agents

```python
from elf_automations.shared.utils import LLMFactory

# Create LLM with automatic quota tracking
llm = LLMFactory.create_with_quota_tracking(
    team_name="marketing-team",
    preferred_provider="openai",
    preferred_model="gpt-4",
    temperature=0.7
)

# Use in agent
agent = Agent(
    role="Marketing Manager",
    llm=llm,
    # ... other settings
)
```

### 2. Checking Usage

```python
# Get remaining budget for today
remaining = llm.get_remaining_budget()
print(f"Remaining budget: ${remaining:.2f}")

# Get usage report
report = llm.get_usage_report(days=7)
print(f"Total spent (7 days): ${report['total_cost']:.2f}")
```

### 3. Monitoring Dashboard

```bash
# View current usage across all teams
python scripts/quota_dashboard.py

# Watch mode (refreshes every 30s)
python scripts/quota_dashboard.py --watch
```

## How It Works

### Cost Tracking

The system tracks costs based on actual token usage:

| Model | Input Cost | Output Cost |
|-------|------------|-------------|
| GPT-4 | $0.03/1K | $0.06/1K |
| GPT-3.5 Turbo | $0.0005/1K | $0.0015/1K |
| Claude-3 Opus | $0.015/1K | $0.075/1K |
| Claude-3 Haiku | $0.00025/1K | $0.00125/1K |

### Automatic Fallback

When approaching budget limits:
1. System warns at 80% usage
2. Suggests cheaper alternatives
3. Automatically switches models if needed
4. Prevents overage by blocking requests

### Budget Management

Default daily budget: **$10 per team**

Custom budgets can be set:
```python
from elf_automations.shared.quota import QuotaManager

quota_manager = QuotaManager()
quota_manager.set_team_budget("sales-team", 25.0)  # $25/day
```

## Integration Examples

### 1. Team Factory Integration

When creating teams, quota tracking is automatically included:

```python
# In agent files generated by team_factory.py
def marketing_manager_agent(llm=None, ...):
    if not llm:
        llm = LLMFactory.create_with_quota_tracking(
            team_name="marketing-team",
            preferred_provider="openai",
            preferred_model="gpt-4"
        )
    # ... rest of agent creation
```

### 2. CrewAI Integration

```python
class MarketingCrew:
    def __init__(self):
        # Share quota manager across team
        self.quota_manager = QuotaManager()

        # Create agents with shared quota
        self.manager = create_agent(
            "Manager",
            quota_manager=self.quota_manager
        )
        self.writer = create_agent(
            "Writer",
            quota_manager=self.quota_manager
        )
```

### 3. Task Execution

```python
# Before expensive operations
if llm.get_remaining_budget() < 0.50:
    logger.warning("Low budget - switching to concise mode")
    task.description += " Be very concise to save tokens."
```

## Best Practices

### 1. Budget Planning

- **Development**: $5-10/day per team
- **Production**: $20-50/day per team
- **High-volume**: Custom budgets based on ROI

### 2. Cost Optimization

- Use cheaper models for simple tasks
- Keep system prompts concise
- Limit agent iterations (`max_iter=5`)
- Set execution timeouts
- Cache common responses

### 3. Monitoring

- Check dashboard daily
- Set up alerts for 80% usage
- Review weekly trends
- Optimize high-cost operations

## Troubleshooting

### "Quota exceeded" Errors

1. Check current usage:
```bash
python scripts/quota_dashboard.py
```

2. Increase budget if needed:
```python
quota_manager.set_team_budget("team-name", 50.0)
```

3. Switch to cheaper model:
```python
llm = LLMFactory.create_with_quota_tracking(
    preferred_model="gpt-3.5-turbo"  # Much cheaper
)
```

### Missing Usage Data

- Ensure quota tracking is enabled in LLM creation
- Check that usage data directory exists: `~/.elf_automations/quota_data/`
- Verify team names match exactly

### Fallback Not Working

- Check both OpenAI and Anthropic API keys are set
- Ensure `enable_fallback=True` (default)
- Review logs for fallback attempts

## Advanced Configuration

### Custom Quota Storage

```python
from pathlib import Path

custom_path = Path("/shared/quota_data")
quota_manager = QuotaManager(
    storage_path=custom_path,
    default_daily_budget=25.0,
    warning_threshold=0.7  # Warn at 70%
)
```

### Team Hierarchies

```python
# Department-wide budgets
dept_budget = 100.0  # $100 for all marketing teams
for team in ["marketing-team", "content-team", "social-team"]:
    quota_manager.set_team_budget(team, dept_budget / 3)
```

### Export Usage Data

```python
import json

# Export for billing
report = {}
for team in teams:
    report[team] = quota_manager.get_usage_report(team, days=30)

with open("monthly_usage.json", "w") as f:
    json.dump(report, f, indent=2)
```

## Future Enhancements

1. **Supabase Integration**: Store usage data in Supabase for better analytics
2. **Real-time Alerts**: Webhook notifications for budget warnings
3. **Predictive Budgeting**: ML-based budget recommendations
4. **Cross-team Pooling**: Shared budgets for departments
5. **Usage Analytics**: Detailed breakdowns by task type

## Summary

The quota tracking system is essential for:
- ðŸ’° Controlling costs
- ðŸ“Š Understanding usage patterns
- ðŸš¦ Preventing service interruptions
- ðŸ“ˆ Optimizing team efficiency

Always use `create_with_quota_tracking()` when creating LLMs for production agents!
